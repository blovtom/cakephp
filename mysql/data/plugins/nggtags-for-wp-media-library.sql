insert into plugins (id, name, testedUpTo, stableTag, requiresAtLeast, created, modified) values (2907, "Tags for Media Library", "4.1", "0.10", "4.0", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53191, 2907, "update_galleries", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53192, 2907, "update_post_content", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53193, 2907, "view_switcher", "/upload.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53194, 2907, "register_nextgen_gallery_taxonomy", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53195, 2907, "update_term_relationships_setup", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53196, 2907, "is_nggtags_media_library_request", "/nggtags-for-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53197, 2907, "send_all_messages_to_browser", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53198, 2907, "update_thumbnails", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53199, 2907, "move_picture_to_wordpress_upload_directory", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53200, 2907, "ngg_wp_plupload_default_settings", "/upload.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53201, 2907, "update_attachment_metadata", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53202, 2907, "update_pictures", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53203, 2907, "register_new_ngg_tag_taxonomy_for_wp_attachments", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53204, 2907, "update_to_wp_media_library", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53205, 2907, "update_term_relationships", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53206, 2907, "update_albums", "/update-to-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53207, 2907, "sort_ids_by_priority", "/nggtags-for-wp-media-library.php", now(), now());
insert into functions (id, plugin_id, function_name, function_loc, created, modified) values (53208, 2907, "ngg_upload", "/upload.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390821, 2907, "WP_Media_List_Table_for_Ngg_Tags", "extra_tablenav", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390822, 2907, "WP_Media_List_Table_for_Ngg_Tags", "inline_edit", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390823, 2907, "WP_Media_List_Table_for_Ngg_Tags", "type_filter", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390824, 2907, "Search_Media_Library_by_Taxonomy_Widget", "__construct", "/nggtags-search-widget.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390825, 2907, "Search_Media_Library_by_Taxonomy_Widget", "widget", "/nggtags-search-widget.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390826, 2907, "WP_Media_List_Table_for_Ngg_Tags", "get_bulk_actions", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390827, 2907, "WP_Media_List_Table_for_Ngg_Tags", "views", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390828, 2907, "WP_Media_List_Table_for_Ngg_Tags", "row_actions", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390829, 2907, "WP_Media_List_Table_for_Ngg_Tags", "taxonomy_filter", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390830, 2907, "Search_Media_Library_by_Taxonomy_Widget", "form", "/nggtags-search-widget.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390831, 2907, "Search_Media_Library_by_Taxonomy_Widget", "update", "/nggtags-search-widget.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390832, 2907, "WP_Media_List_Table_for_Ngg_Tags", "upload_to_filter", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390833, 2907, "WP_Media_List_Table_for_Ngg_Tags", "__construct", "/class-wp-media-list-table-for-nggtags.php", now(), now());
insert into methods (id, plugin_id, class_name, method_name, method_loc, created, modified) values (390834, 2907, "Search_Media_Library_by_Taxonomy_Widget", "join_arrays", "/nggtags-search-widget.php", now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31760, 2907, "wp_ajax_nggml_get_image", "function ()
{
	$id = (int) $_GET['nggml_image_id'];$image = get_post($id,OBJECT);?><div class="nggml-overlay-right">
    <?phpecho(wp_get_attachment_image($id,'full'));?></div>
<div class="nggml-overlay-left">
    <h1><?phpecho(get_the_title($id));?></h1>
    <div class="nggml-overlay-caption"><p><?phpecho($image->post_excerpt);?></p></div>
    <div class="nggml-overlay-description"><p><?phpecho($image->post_content);?></p></div>
</div>
<?phpexit();
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31761, 2907, "wp_ajax_nggml_update_screen_options", "function ()
{
	$nggml_screen_options = array_map(function ($v)
{
	return is_numeric($v)?intval($v):$v;
},$_POST['nggml_screen_options']);update_option('nggml_screen_options',$nggml_screen_options);exit();
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31762, 2907, "template_redirect", "function ()
{
	global $wp_query;global $wpdb;$posts = array_map(function ($post)
{
	return $post->ID;
},$wp_query->posts);$posts = NggTags_for_Media_Library::sort_ids_by_priority($posts);$posts_imploded = implode(', ',$posts);get_header();echo('<div style="position:relative;background-color:lightgray;z-index:10000;">');echo('<h1 style="text-align:center;margin-bottom:50px;">Media Library Search Results</h1>');$gallery_options = get_option('search_results_for_media_library_gallery_options','');if(!empty($gallery_options)) {
	$gallery_options = (' ' . trim($gallery_options));
}echo(do_shortcode('[gallery ids="'.$posts_imploded.'"'.$gallery_options.']'));require_once (dirname(__FILE__) . '/nggtags-meta-overlay-template.php');echo('</div>');get_footer();exit();
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31763, 2907, "init", "function ()
{
	$labels = array('name' => _x('Priority','taxonomy general name'),'singular_name' => _x('Priority','taxonomy singular name'));register_taxonomy('priority','attachment',array('label' => __('Priority'),'labels' => $labels,'show_ui' => true,'show_admin_column' => true,'rewrite' => array('slug' => 'priority')));register_taxonomy_for_object_type('priority','attachment');$labels = array('name' => _x('Exclude','taxonomy general name'),'singular_name' => _x('Exclude','taxonomy singular name'));register_taxonomy('exclude','attachment',array('label' => __('Exclude'),'labels' => $labels,'show_ui' => true,'show_admin_column' => true,'rewrite' => array('slug' => 'exclude')));register_taxonomy_for_object_type('exclude','attachment');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31764, 2907, "admin_notices", "function () use ('major','minor','tested_major','tested_minor')
{
	echo('<div style="padding:10px 20px;border:2px solid red;margin:50px 20px;font-weight:bold;">
    NextGEN Gallery's nggtags for WordPress's Media Library will not work with PHP version '.$major.'.'.$minor.';
    Please uninstall it or upgrade your PHP version to '.$tested_major.'.'.$tested_minor.' or later.
</div>');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31765, 2907, "wp_enqueue_scripts", "function ()
{
	wp_enqueue_script('jquery');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31766, 2907, "parse_query", "function (&$query)
{
	if((!$query->is_main_query() || !array_key_exists('search_media_library_for_nggtags_form',$_REQUEST))) {
	return;
}$option = get_option($_REQUEST['search_media_library_for_nggtags_widget_option']);$number = $_REQUEST['search_media_library_for_nggtags_widget_number'];if(isset($option[$number]['set_is_search'])) {
	$query->is_search = true;
}
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31767, 2907, "wp_ajax_nopriv_nggml_get_attachment_meta", "$nggml_get_attachment_meta", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31768, 2907, "widgets_init", "function ()
{
	register_widget('Search_Media_Library_by_Taxonomy_Widget');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31769, 2907, "wp_ajax_nggml_get_media_table_rows", "function ()
{
	global $wp_query;require_once (ABSPATH . 'wp-admin/includes/class-wp-list-table.php');require_once (ABSPATH . 'wp-admin/includes/class-wp-media-list-table.php');require_once (dirname(__FILE__) . '/class-wp-media-list-table-for-nggtags.php');$GLOBALS['hook_suffix'] = 'nggtags-for-wp-media-library/upload.php';$wp_list_table = (new WP_Media_List_Table_for_Ngg_Tags(null));$wp_list_table->is_trash = false;query_posts(array('post_type' => 'attachment','post__in' => $_REQUEST['data'],'post_status' => 'inherit','posts_per_page' => -1));$wp_list_table->display_rows();exit();
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31770, 2907, "admin_menu", "function ()
{
	add_options_page('Tags for Media Library Settings','Tags for Media Library','manage_options','nggtags_for_media_library_settings_page',function ()
{
	echo('<form method="post" action="options.php">');settings_fields('nggtags_for_media_library_settings');do_settings_sections('nggtags_for_media_library_settings_page');submit_button();echo('</form>');
});add_media_page('Tags for Media Library','Tags for Media Library','edit_posts','nggtags-for-wp-media-library/upload.php');
}", 11, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31771, 2907, "admin_init", "function ()
{
	global $max_taxonomies;add_settings_section('nggtags_for_media_library_settings_section','Tags for Media Library Settings',function ()
{
	?><div style="margin:10px 20px;padding:5px 10px;font-size:smaller;">
Since the NextGEN Gallery shortcodes -
<a href="http://nggtagsforwpml.wordpress.com/#nggtags" target="_blank">nggtags</a>,
<a href="http://nggtagsforwpml.wordpress.com/#nggallery-singlepic" target="_blank">nggallery</a> and
<a href="http://nggtagsforwpml.wordpress.com/#nggallery-singlepic" target="_blank">singlepic</a> - are implemented
using WordPress's gallery shortcode the options are the same as
<a href="http://codex.wordpress.org/Gallery_Shortcode" target="_blank">the options of WordPress's gallery shortcode</a>.
These options will automatically be added to the corresponding shortcodes in your post content.
</div>
<?php
},'nggtags_for_media_library_settings_page');add_settings_field('nggtags_for_media_library_gallery_options','nggtags options',function ()
{
	?><input id="nggtags_for_media_library_gallery_options" name="nggtags_for_media_library_gallery_options" type="text"
    size="40" value='<?phpecho(get_option('nggtags_for_media_library_gallery_options'));?>'
    placeholder='e.g. size="thumbnail" link="file" columns="4"'/>
<?php
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('nggallery_for_media_library_gallery_options','nggallery options',function ()
{
	?><input id="nggallery_for_media_library_gallery_options" name="nggallery_for_media_library_gallery_options" type="text"
    size="40" value='<?phpecho(get_option('nggallery_for_media_library_gallery_options'));?>'
    placeholder='e.g. size="thumbnail" link="file" columns="4"'/>
<?php
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('singlepic_for_media_library_gallery_options','singlepic options',function ()
{
	?><input id="singlepic_for_media_library_gallery_options" name="singlepic_for_media_library_gallery_options" type="text"
    size="40" value='<?phpecho(get_option('singlepic_for_media_library_gallery_options'));?>'
    placeholder='e.g. size="full" columns="1"'/>
<?php
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('search_results_for_media_library_gallery_options','search results options',function ()
{
	?><input id="search_results_for_media_library_gallery_options" name="search_results_for_media_library_gallery_options"
    type="text" size="40" value='<?phpecho(get_option('search_results_for_media_library_gallery_options'));?>'
    placeholder='e.g. size="e.g. size="thumbnail" link="file" columns="4"'/>
<?php
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('nggml_user_css_file_url','URL of user CSS file',function ()
{
	?><input id="nggml_user_css_file_url" name="nggml_user_css_file_url" type="text" size="40"
    value="<?phpecho(get_option('nggml_user_css_file_url',''));?>"/>
<?phpecho('&nbsp;&nbsp;use to override the plugin's css file');
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('nggml_alt_high_density_gallery_enable','enable alternate gallery view',function ()
{
	?><input id="nggml_alt_high_density_gallery_enable" name="nggml_alt_high_density_gallery_enable"
    type="checkbox" value="enabled"
    <?phpecho((get_option('nggml_alt_high_density_gallery_enable','enabled') === 'enabled')?' checked':'');?> />
<?phpecho('&nbsp;&nbsp;for the user (not admin) alternate gallery view');
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('nggml_alt_high_density_gallery_image_width','alternate gallery view image width',function ()
{
	?><input id="nggml_alt_high_density_gallery_image_width" name="nggml_alt_high_density_gallery_image_width"
    type="number" min="16" max="1024" size="40"
    value='<?phpecho(get_option('nggml_alt_high_density_gallery_image_width','64'));?>' />
<?phpecho('&nbsp;&nbsp;for the user (not admin) alternate gallery view');
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');add_settings_field('nggml_alt_high_density_gallery_focus_color','alternate gallery view highlight color',function ()
{
	?><input id="nggml_alt_high_density_gallery_focus_color" name="nggml_alt_high_density_gallery_focus_color"
    type="text" size="40"
    value='<?phpecho(get_option('nggml_alt_high_density_gallery_focus_color','yellow'));?>' />
<?phpecho('&nbsp;&nbsp;for the user (not admin) alternate gallery view');
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_settings_section');register_setting('nggtags_for_media_library_settings','nggtags_for_media_library_gallery_options');register_setting('nggtags_for_media_library_settings','nggallery_for_media_library_gallery_options');register_setting('nggtags_for_media_library_settings','singlepic_for_media_library_gallery_options');register_setting('nggtags_for_media_library_settings','search_results_for_media_library_gallery_options');register_setting('nggtags_for_media_library_settings','nggml_user_css_file_url');register_setting('nggtags_for_media_library_settings','nggml_alt_high_density_gallery_enable');register_setting('nggtags_for_media_library_settings','nggml_alt_high_density_gallery_image_width');register_setting('nggtags_for_media_library_settings','nggml_alt_high_density_gallery_focus_color');add_settings_section('nggtags_for_media_library_taxonomy_section','Taxonomies for Media Library',function ()
{
	?><div style="margin:10px 20px;padding:5px 10px;font-size:smaller;">
In addition to Ngg Tags you can <a href="http://nggtagsforwpml.wordpress.com/#additional-taxonomies" target="_blank">create
your own tag taxonomies</a> for Media Library images.
</div>
<?php
},'nggtags_for_media_library_settings_page');$taxonomy_count = ($max_taxonomies + 1);for($i = 1 ; ($i <= $taxonomy_count) ; $i++) {
	if(($i === $taxonomy_count)) {
	if(!empty($first_empty_i)) {
		$use_i = $first_empty_i;
		$taxonomy_slug = 'nggtags_for_media_library_taxonomy_slug_'.$use_i;
		$taxonomy_name = 'nggtags_for_media_library_taxonomy_name_'.$use_i;
	}
	else {
	  break;
	}
	
}
else {
  $use_i = $i;$taxonomy_slug = 'nggtags_for_media_library_taxonomy_slug_'.$i;$taxonomy_name = 'nggtags_for_media_library_taxonomy_name_'.$i;
}
$taxonomy_name_value = get_option($taxonomy_name);if(($i === 1)) {
	$taxonomy_slug_value = 'ngg_tag';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'NGG Tags';
	}
}
else {
  if(($i === 2)) {
	$taxonomy_slug_value = 'priority';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'Priority';
	}
}
else {
  if(($i === 3)) {
	$taxonomy_slug_value = 'exclude';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'Exclude';
	}
}
else {
  $taxonomy_slug_value = get_option($taxonomy_slug);
}

}

}
if(empty($taxonomy_slug_value)) {
	if(($i !== $taxonomy_count)) {
		if(empty($first_empty_i)) {
			$first_empty_i = $i;
		}
		continue;
	}
	$taxonomy_name_value = '';
}add_settings_field($taxonomy_name,'Taxonomy Name '.$use_i,function () use ('taxonomy_name','taxonomy_name_value','use_i')
{
	?><input id="<?phpecho($taxonomy_name);?>" name="<?phpecho($taxonomy_name);?>" type="text"
    class="nggtags_for_media_library_taxonomy_name"
    size="40" value="<?phpecho($taxonomy_name_value);?>" placeholder="enter new taxonomy name" />
<?phpif(($use_i === 2)) {
	echo('&nbsp;&nbsp;this number sets the order in a TLM gallery - smaller is earlier');
}
else {
  if(($use_i === 3)) {
	echo('&nbsp;&nbsp;a yes value will exclude this image from a TLM gallery');
}
}

},'nggtags_for_media_library_settings_page','nggtags_for_media_library_taxonomy_section');add_settings_field($taxonomy_slug,'Taxonomy Slug '.$use_i,function () use ('taxonomy_slug','taxonomy_slug_value','use_i','i','taxonomy_count')
{
	?><input id="<?phpecho($taxonomy_slug);?>" name="<?phpecho($taxonomy_slug);?>" type="text"
    size="40" value="<?phpecho($taxonomy_slug_value);?>" placeholder="enter new taxonomy slug"
    <?phpif(($use_i <= 3)) {
	echo('disabled');
}?> />
<?phpif((!empty($taxonomy_slug_value) && ($use_i > 3))) {
	echo('&nbsp;&nbsp;an empty slug value will delete this taxonomy');
}if(($i === $taxonomy_count)) {
	?><script type="text/javascript">
	(function(){
	    var list=document.querySelectorAll("input.nggtags_for_media_library_taxonomy_name");
	    for(var i=0;i<list.length;i++){
	        list.item(i).addEventListener("change",function(){
	            document.getElementById(this.id.replace("name","slug")).value=this.value.toLowerCase().replace(/[^a-z0-9]+/g,"-");
	        });
	    }
	})();
	</script>
	<?php
}
},'nggtags_for_media_library_settings_page','nggtags_for_media_library_taxonomy_section');register_setting('nggtags_for_media_library_settings',$taxonomy_slug);register_setting('nggtags_for_media_library_settings',$taxonomy_name);
}add_filter('pre_update_option',function ($new_value,$option,$old_value)
{
	if((strpos($option,'nggtags_for_media_library_taxonomy_slug_') !== 0)) {
	return $new_value;
}if(($old_value && $new_value)) {
	return $old_value;
}return $new_value;
},10,3);add_action('updated_option',function ($option,$old_value,$new_value)
{
	global $wpdb;if((sscanf($option,'nggtags_for_media_library_taxonomy_slug_%d',$index) !== 1)) {
	return;
}if($new_value) {
	return;
}$ids = $wpdb->get_col('SELECT r.object_id FROM '.$wpdb->term_relationships.' r, '.$wpdb->term_taxonomy.' x
    WHERE r.term_taxonomy_id = x.term_taxonomy_id AND x.taxonomy = "'.$old_value.'"');foreach($ids as $id) {
	wp_delete_object_term_relationships($id,$old_value);
}$ids = $wpdb->get_col('SELECT term_id FROM '.$wpdb->term_taxonomy.' WHERE taxonomy = ''.$old_value.''');foreach($ids as $id) {
	wp_delete_term($id,$old_value);
}
},10,3);
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31772, 2907, "wp_loaded", "function ()
{
	global $pagenow;$pagenow = 'upload.php';
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31773, 2907, "admin_enqueue_scripts", "function ()
{
	wp_enqueue_script('jquery-ui-draggable');wp_enqueue_script('jquery-ui-droppable');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31774, 2907, "admin_footer", "'wp_print_media_templates'", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31775, 2907, "admin_notices", "function () use ('major','minor','tested_major','tested_minor')
{
	echo('<div style="padding:10px 20px;border:2px solid red;margin:50px 20px;font-weight:bold;">
    NextGEN Gallery's nggtags for WordPress's Media Library will not work with WordPress version '.$major.'.'.$minor.';
    Please uninstall it or upgrade your WordPress version to '.$tested_major.'.'.$tested_minor.' or later.
</div>');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31776, 2907, "wp_footer", "function ()
{
	require_once (dirname(__FILE__) . '/nggtags-meta-overlay-template.php');
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31777, 2907, "wp_ajax_nggml_get_attachment_meta", "$nggml_get_attachment_meta", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31778, 2907, "admin_menu", "function ()
{
	add_menu_page('Update for Using nggtags on WordPress's Media Library','nggtags for Media Library','manage_options','nggtags_for_media_library',function ()
{
	$nextgen_gallery_activated = class_exists('nggLoader');$options = get_option('nggtags_for_wp_media_library',array());if((!$options || !isset($options['status']))) {
	$continue = 'Start ';
}
else {
  $continue = 'Restart ';
}
?><div style="padding:10px 20px;">
<h1>NextGEN Gallery's nggtags for WordPress's Media Library</h1>
This feature lets you use the shortcode 'nggtags' on Wordpress's Media Library images.
If you have an existing NextGEN Gallery database you must update your database.
This update will copy NextGEN Gallery's pictures and galleries to WordPress's Media Library.
(NextGEN Gallery's albums are ignored.)
After this update NextGEN Gallery will not work.
NextGEN pictures and galleries will now exists as WordPress Media Library images and galleries
and the shortcode 'nggtags' will work with the Media Library images.
Except for 'gallery' and 'album' the parameters to the shortcode 'nggtags' are parameters to
WordPress's 'gallery' shortcode in particular you may need to specify
'<strong>link=&quot;file&quot;</strong>' to make some lightboxes to work.
You may want to <a href="<?phpecho(admin_url('options-media.php'));?>">set the image sizes</a> before starting the update.
<strong>It is imperative that you backup your database before proceeding!</strong>
<div style="border:2px solid black;margin:20px;padding:10px 20px;"><small>
<h4>The Fine Print</h4>
The update actually only copies the NextGEN Gallery picture files
and leaves the NextGEN picture directory - usually 'wp_content/gallery' -
and the NextGEN MySQL tables - wp_ngg_pictures, wp_ngg_gallery and wp_ngg_album - intact.
However, new rows are inserted into the WordPress MySQL tables - wp_posts and wp_postmeta -
and rows are deleted from and inserted into the WordPress MySQL table - wp_term_relationships.
So most of NextGEN Gallery will still work only the tags will stop working as their data in
wp_term_relationships are changed to work with the copied pictures in WordPress's Media Library.
If you are satisfied with 'NextGEN Gallery's nggtags for WordPress's Media Library' you
can delete NextGEN Gallery's picture directory - usually 'wp-content/gallery' -
and the NextGEN Gallery's MySQL tables - wp_ngg_pictures, wp_ngg_gallery and wp_ngg_album - to
save space on your server.
</small></div>
<?phpif($nextgen_gallery_activated) {
	?><div style="border:2px solid red;margin:20px;padding:10px 20px;">
	NextGEN Gallery is activated. You must deactivate NextGEN Gallery before you can run the update.
	</div>
	<?php
}if(!empty($options['messages'])) {
	?><div style="border:2px solid black;margin=20px;padding=20px;"><p><small><ul>
	<h2>Previous Status Messages</h2>
	<?php
	foreach($options['messages'] as $message) {
		echo('<li>'.$message.'</li>');
	}
	?></ul></small></p></div>
	<?php
}?><button id="ntfwml_update_button" type="button"<?phpif($nextgen_gallery_activated) {
	echo(' disabled');
}?>>
    <?phpecho($continue);?>Update for nggtags on Media Library</button>
<div id="ntfwml_status" style="border:2px solid black;margin:20px;padding:20px;display:none;"><p><small>
<h2>Status Messages</h2><ul>
<li>Update started. This may take some time ...</li>
</ul></small></p></div>
</div>
<script type="text/javascript">
jQuery("#ntfwml_update_button").click( function() {
    var confirmed = confirm(
        "Did you really backup your database? "
        + "Pressing OK will make permanent changes to your database. "
        + "After these changes are made NextGEN Gallery will no longer work. "
    );
    if (confirmed) {
        this.disabled = true;
        jQuery( "#ntfwml_status" ).css( "display", "block" );
        var data = {
            'action': 'update_for_nggtags_on_media_library'
        };
        function update() {
            jQuery.post(
                ajaxurl,
                data,
                function(response) {
                    jQuery("#ntfwml_status ul").html(response);
                    if (response.indexOf("The conversion of NextGEN Gallery to WordPress Media Library is done.") === -1) {
                        update();
                    }
                }
            );
        }
        update();
    }
} );
</script>
<?php
});
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31779, 2907, "init", "function ()
{
	global $max_taxonomies;$taxonomy_count = $max_taxonomies;if(get_option('nggtags_for_media_library_taxonomy_slug_3','')) {
	for($i = $taxonomy_count ; ($i >= 3) ; $i--) {
		if($taxonomy_slug_value = get_option('nggtags_for_media_library_taxonomy_slug_'.$i,'')) {
		$j = ($i + 1);
		update_option('nggtags_for_media_library_taxonomy_slug_'.$j,$taxonomy_slug_value);
		update_option('nggtags_for_media_library_taxonomy_name_'.$j,get_option('nggtags_for_media_library_taxonomy_name_'.$i,''));
	}
	}
	update_option('nggtags_for_media_library_taxonomy_slug_3','');
	update_option('nggtags_for_media_library_taxonomy_name_3','');
}for($i = 1 ; ($i <= $taxonomy_count) ; $i++) {
	$taxonomy_slug = 'nggtags_for_media_library_taxonomy_slug_'.$i;$taxonomy_name = 'nggtags_for_media_library_taxonomy_name_'.$i;$taxonomy_name_value = get_option($taxonomy_name);if(($i === 1)) {
	$taxonomy_slug_value = 'ngg_tag';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'NGG Tags';
	}
}
else {
  if(($i === 2)) {
	$taxonomy_slug_value = 'priority';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'Priority';
	}
}
else {
  if(($i === 3)) {
	$taxonomy_slug_value = 'exclude';
	if(empty($taxonomy_name_value)) {
		$taxonomy_name_value = 'Exclude';
	}
}
else {
  $taxonomy_slug_value = get_option($taxonomy_slug);
}

}

}
if(empty($taxonomy_slug_value)) {
	continue;
}register_taxonomy($taxonomy_slug_value,'attachment',array('label' => __($taxonomy_name_value),'labels' => array('name' => _x($taxonomy_name_value,'taxonomy general name'),'singular_name' => _x($taxonomy_name_value,'taxonomy singular name')),'show_ui' => true,'show_admin_column' => true,'rewrite' => array('slug' => $taxonomy_slug_value)));register_taxonomy_for_object_type($taxonomy_slug_value,'attachment');
}
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31780, 2907, "admin_head", "function ()
{
	?>      <base href="<?phpecho(admin_url());?>">
    <?php
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31781, 2907, "admin_init", "function ()
{
	if((isset($_GET['page']) && ($_GET['page'] === 'nggtags-for-wp-media-library/upload.php'))) {
	wp_redirect(plugins_url('upload.php',__FILE__));
}
}", 1, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31782, 2907, "wp_enqueue_scripts", "function ()
{
	global $wp_scripts;wp_enqueue_style('dashicons');wp_enqueue_style('nggml_search',plugins_url('nggml_search.css',__FILE__));$user_css_url = get_option('nggml_user_css_file_url','');if($user_css_url) {
	wp_enqueue_style('nggml_user',$user_css_url,array('nggml_search'));
}wp_enqueue_script('nggml-search',plugins_url('nggml-search.js',__FILE__),array('jquery'));$wp_scripts->add_data('nggml-search','data',(((((((((('var nggmlAltGalleryImageWidth=' . get_option('nggml_alt_high_density_gallery_image_width','64')) . ';') . 'var nggmlAltGalleryFocusColor="') . get_option('nggml_alt_high_density_gallery_focus_color','yellow')) . '";') . 'var nggmlAltGalleryEnabled=') . (get_option('nggml_alt_high_density_gallery_enable','enabled') === 'enabled')?'true;':'false;') . 'var ajaxurl="') . admin_url('admin-ajax.php')) . '";'));
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31783, 2907, "updated_option", "function ($option,$old_value,$new_value)
{
	global $wpdb;if((sscanf($option,'nggtags_for_media_library_taxonomy_slug_%d',$index) !== 1)) {
	return;
}if($new_value) {
	return;
}$ids = $wpdb->get_col('SELECT r.object_id FROM '.$wpdb->term_relationships.' r, '.$wpdb->term_taxonomy.' x
    WHERE r.term_taxonomy_id = x.term_taxonomy_id AND x.taxonomy = "'.$old_value.'"');foreach($ids as $id) {
	wp_delete_object_term_relationships($id,$old_value);
}$ids = $wpdb->get_col('SELECT term_id FROM '.$wpdb->term_taxonomy.' WHERE taxonomy = ''.$old_value.''');foreach($ids as $id) {
	wp_delete_term($id,$old_value);
}
}", 10, now(), now());
insert into hooks (id, plugin_id, hook_name, hook_callback, hook_priority, created, modified) values (31784, 2907, "wp_ajax_update_for_nggtags_on_media_library", "function ()
{
	global $ntfwml_ngg_pictures;global $ntfwml_ngg_galleries;global $ntfwml_ngg_album;global $ntfwml_options;global $update_galleries_limit;global $update_pictures_limit;global $update_albums_limit;global $update_thumbnails_limit;global $update_term_relationships_setup_limit;global $update_term_relationships_limit;global $update_post_content_limit;global $update_attachment_metadata_limit;function register_nextgen_gallery_taxonomy() {
	global $wp_rewrite;$args = array('label' => __('Picture tag','nggallery'),'template' => __('Picture tag: %2$l.','nggallery'),'helps' => __('Separate picture tags with commas.','nggallery'),'sort' => true,'args' => array('orderby' => 'term_order'));register_taxonomy('ngg_tag','nggallery',$args);
}function update_galleries($ngg_galleries,$limit) {
	global $wpdb;$done_gids = $wpdb->get_col('SELECT meta_value from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_gid'');$results = $wpdb->get_results('SELECT gid, name, title, galdesc, previewpic, author FROM '.$ngg_galleries.' ORDER BY gid');$count = 0;foreach($results as $result) {
	if(!in_array($result->gid,$done_gids)) {
		if(empty($first_id)) {
			$first_id = $result->gid;
		}
		$post = array('post_author' => $result->author,'post_content' => '<!-- This post is used to hold the pictures in a NextGEN Gallery gallery.
		     This gallery is intended to be displayed using NextGen Gallery's nggallery shortcode. -->
		[gallery]','post_excerpt' => $result->galdesc,'post_name' => $result->name,'post_status' => 'publish','post_title' => 'Gallery: '.$result->title,'post_type' => 'page');
		if($id = wp_insert_post($post)) {
			update_post_meta($id,'_thumbnail_id',('TODO:' . $result->previewpic));
			update_post_meta($id,'pre_update_ngg_gid',$result->gid);
			if((++$count === $limit)) {
				return 'Galleries for ids '.$first_id.' to '.$result->gid.' done.';
			}
		}
	}
}return true;
}function move_picture_to_wordpress_upload_directory($file,&$options) {
	$uploads = wp_upload_dir(null);if((!$uploads || ($uploads['error'] !== false))) {
	$options['messages'][] = $uploads['error'];
	return false;
}$uploads['path'] = str_replace('\','/',$uploads['path']);$file_atts = wp_check_filetype_and_ext($file,basename($file));if(!empty($file_atts['proper_filename'])) {
	$new_file_name = $file_atts['proper_filename'];
}
else {
  $new_file_name = basename($file);
}
$i = strrpos($new_file_name,'.');if(($i === false)) {
	$options['messages'][] = $file.' is an invalid picture file.';
	return false;
}$basename = substr($new_file_name,0,$i);$extension = substr($new_file_name,$i);$upload_file = $uploads['path'].'/'.$new_file_name;$i = 0;while(true) {
	if(!file_exists($upload_file)) {
	break;
}$tag = ('-' . (string) $i++);$new_file_name = $basename.$tag.$extension;$upload_file = $uploads['path'].'/'.$new_file_name;
}if((@copy($file,$upload_file) === false)) {
	$options['messages'][] = 'copy of "'.$file.'" to "'.$upload_file.'" failed.';
	return false;
}return array('file' => $upload_file,'type' => $file_atts['type'],'subdirpath' => ltrim($uploads['subdir'].'/'.$new_file_name,'/'),'url' => ($uploads['url'] . '/'.$new_file_name));
}function update_pictures($ngg_pictures,$ngg_galleries,&$options,$limit) {
	global $wpdb;$debug_option = get_option('nggtags_for_wp_media_library_debug_option',false);if($debug_option) {
	list($debug_option_name, $debug_option_value) = explode(':',$debug_option);
	if(($debug_option_name == 'update_pictures_abort')) {
		$die_count = $debug_option_value;
	}
}$new_gids = $wpdb->get_results('SELECT meta_value, post_id from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_gid'',OBJECT_K);$done_pids = $wpdb->get_col('SELECT meta_value from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_pid'');$gallery_paths = $wpdb->get_results('SELECT gid, path FROM '.$ngg_galleries,OBJECT_K);$results = $wpdb->get_results('SELECT pid, image_slug, galleryid, filename, description, alttext, imagedate, exclude, sortorder
    FROM '.$ngg_pictures.' ORDER BY sortorder ASC');$count = 0;foreach($results as $result) {
	if((!empty($die_count) && ($count >= $die_count))) {
		exit('simulated timeout for testing recovery');
	}
	if(!in_array($result->pid,$done_pids)) {
		if(empty($first_id)) {
			$first_id = $result->pid;
		}
		if(array_key_exists($result->galleryid,$new_gids)) {
			$post_id = $new_gids[$result->galleryid]->post_id;
			$path = (ABSPATH . $gallery_paths[$result->galleryid]->path);
			$file = $path.'/'.$result->filename;
			$move_results = move_picture_to_wordpress_upload_directory($file,$options);
			if($move_results) {
				$post = array('guid' => $move_results['url'],'post_content' => $result->description,'post_date' => $result->imagedate,'post_excerpt' => $result->description,'post_mime_type' => $move_results['type'],'post_name' => $result->image_slug,'post_parent' => $post_id,'post_status' => 'inherit','post_title' => $result->alttext,'post_type' => 'attachment');
				if($id = wp_insert_post($post)) {
					update_post_meta($id,'_wp_attached_file',$move_results['subdirpath']);
					update_post_meta($id,'_wp_attachment_image_alt',$result->alttext,true);
					update_post_meta($id,'TODO:attachment_metadata',$move_results['file']);
					wp_set_post_terms($id,(100 * $result->sortorder),'priority');
					if($result->exclude) {
						wp_set_post_terms($id,'yes','exclude');
					}
					update_post_meta($id,'pre_update_ngg_pid',$result->pid);
					if((++$count === $limit)) {
						return 'Pictures for ids '.$first_id.', ..., '.$result->pid.' done.';
					}
				}
			}
		}
	}
}return true;
}function update_albums($ngg_album,$limit) {
	global $wpdb;$new_gids = $wpdb->get_results('SELECT meta_value, post_id from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_gid'',OBJECT_K);$done_ids = $wpdb->get_col('SELECT meta_value from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_id'');$results = $wpdb->get_results('SELECT id, name, slug, previewpic, albumdesc, sortorder FROM '.$ngg_album.' ORDER BY id');$count = 0;foreach($results as $result) {
	if(!in_array($result->id,$done_ids)) {
		if(empty($first_id)) {
			$first_id = $result->id;
		}
		$post_content = '<!-- This post is used to hold the galleries in a NextGEN Gallery album.
		     This album is intended to be displayed using NextGen Gallery's album shortcode. -->';
		foreach(unserialize($result->sortorder) as $gallery) {
			$new_gallery = array_key_exists($gallery,$new_gids)?$new_gids[$gallery]->post_id:'';
			if($post_content) {
				$post_content .= '
				<hr>
				';
			}
			$post_content .= '[nggallery id="'.$new_gallery.'" nggid="'.$gallery.'"]';
		}
		$post = array('post_content' => $post_content,'post_excerpt' => $result->albumdesc,'post_name' => $result->slug,'post_status' => 'publish','post_title' => 'Album: '.$result->name,'post_type' => 'page');
		if($id = wp_insert_post($post)) {
			update_post_meta($id,'pre_update_ngg_id',$result->id);
			if((++$count === $limit)) {
				return 'Albums for ids '.$first_id.' to '.$result->id.' done.';
			}
		}
	}
}return true;
}function update_thumbnails($limit) {
	global $wpdb;$new_pids = $wpdb->get_results('SELECT meta_value, post_id from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_pid'',OBJECT_K);$results = $wpdb->get_results('SELECT post_id, meta_value FROM '.$wpdb->postmeta.' WHERE meta_key = '_thumbnail_id' AND meta_value LIKE 'TODO:%' ORDER BY post_id');$first_id = current($results)->post_id;$count = 0;foreach($results as $result) {
	$new_pid = $new_pids[substr($result->meta_value,5)]->post_id;
	update_post_meta($result->post_id,'_thumbnail_id',$new_pid);
	if((++$count === $limit)) {
		return 'Thumbnails for ids '.$first_id.' to '.$result->post_id.' done.';
	}
}return true;
}function update_term_relationships_setup($ngg_pictures,&$options,$limit) {
	global $wpdb;$pids = $wpdb->get_col('SELECT pid FROM '.$ngg_pictures.' ORDER BY pid');if(!array_key_exists('term_relationships',$options)) {
	$options['term_relationships'] = array();
}$count = 0;$done_pids = array();foreach($pids as $pid) {
	if(!array_key_exists($pid,$options['term_relationships'])) {
		if(empty($first_id)) {
			$first_id = $pid;
		}
		$options['term_relationships'][$pid] = wp_get_object_terms($pid,'ngg_tag',array('fields' => 'ids'));
		$done_pids[] = $pid;
		if((++$count === $limit)) {
			update_option('nggtags_for_wp_media_library',$options);
			foreach($done_pids as $pid) {
				wp_delete_object_term_relationships($pid,array('ngg_tag'));
			}
			return 'Term relationships setup for ids '.$first_id.' to '.$pid.' done.';
		}
	}
}update_option('nggtags_for_wp_media_library',$options);foreach($done_pids as $pid) {
	wp_delete_object_term_relationships($pid,array('ngg_tag'));
}return true;
}function update_term_relationships($ngg_pictures,&$options,$limit) {
	global $wpdb;if(isset($options['term_relationships'])) {
	$new_pids = $wpdb->get_results('SELECT meta_value, post_id from '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_pid'',OBJECT_K);
	$first_id = key($options['term_relationships']);
	$count = 0;
	foreach($options['term_relationships'] as $pid => &$term_ids) {
		if((array_key_exists($pid,$new_pids) and $new_pid = $new_pids[$pid]->post_id)) {
			$int_term_ids = array_map(function ($value)
			{
				return (int) $value;
			},$term_ids);
			wp_set_post_terms($new_pid,$int_term_ids,'ngg_tag');
			$term_ids = null;
			if((++$count === $limit)) {
				$options['term_relationships'] = array_filter($options['term_relationships']);
				update_option('nggtags_for_wp_media_library',$options);
				return 'Term relationships for ids '.$first_id.', ..., '.$pid.' done.';
			}
		}
	}
}return true;
}function update_post_content($limit) {
	global $wpdb;$new_gids = $wpdb->get_results('SELECT meta_value, post_id FROM '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_gid'',OBJECT_K);$new_pids = $wpdb->get_results('SELECT meta_value, post_id FROM '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_pid'',OBJECT_K);$new_ids = $wpdb->get_results('SELECT meta_value, post_id FROM '.$wpdb->postmeta.' WHERE meta_key = 'pre_update_ngg_id'',OBJECT_K);$fix_shortcode = function ($matches) use ('new_gids','new_pids','new_ids')
{
	if((strpos($matches[0],'nggid') !== false)) {
	return $matches[0];
}$new_xids = ($matches[1] === 'nggallery')?$new_gids:($matches[1] === 'singlepic')?$new_pids:$new_ids;$fix_id = function ($matches) use ('new_xids')
{
	$mlid = $new_xids[$matches[3]]->post_id;return ' id="'.$mlid.'" nggid="'.$matches['3'].'"';
};return preg_replace_callback('#\sid=(("|')?)(\d+)\1#',$fix_id,$matches[0]);
};$fix_old_singlepic = function ($matches) use ('new_pids')
{
	$mlid = $new_pids[$matches[1]]->post_id;return '[singlepic id="'.$mlid.'" nggorig="'.$matches[1].$matches[2].$matches[3].'"]';
};$results = $wpdb->get_results('SELECT ID, post_content FROM '.$wpdb->posts.'
    WHERE ( post_content LIKE '%[nggallery %' OR post_content LIKE '%[singlepic %' OR post_content LIKE '%[singlepic=%'
        OR post_content LIKE '%[album %' ) AND post_content NOT LIKE '% nggid=%' AND post_status = 'publish' ORDER BY ID',OBJECT_K);$first_id = key($results);$count = 0;foreach($results as $post_id => $result) {
	$post_content = preg_replace_callback('#\[(nggallery|singlepic|album)\s[^\]]*\]#',$fix_shortcode,$result->post_content);
	$post_content = preg_replace_callback('#\[singlepic=(\d+)(,?)([^\]]*)\]#',$fix_old_singlepic,$post_content);
	$post = array('ID' => $post_id,'post_content' => $post_content);
	wp_update_post($post);
	if((++$count === $limit)) {
		return 'Post content for post ids '.$first_id.' to '.$post_id.' done.';
	}
}return true;
}function update_attachment_metadata($limit) {
	global $wpdb;$results = $wpdb->get_results('SELECT post_id, meta_value file from '.$wpdb->postmeta.' WHERE meta_key = 'TODO:attachment_metadata' ORDER BY post_id',OBJECT_K);$first_id = key($results);$count = 0;foreach($results as $id => $result) {
	$metadata = wp_generate_attachment_metadata($id,$result->file);
	wp_update_attachment_metadata($id,$metadata);
	delete_post_meta($id,'TODO:attachment_metadata');
	if((++$count === $limit)) {
		return 'Attachment metadata for ids '.$first_id.' to '.$id.' done.';
	}
}return true;
}function send_all_messages_to_browser($options,$die,$status = null) {
	if(!empty($options['messages'])) {
	foreach($options['messages'] as $message) {
		echo('<li>'.$message.'</li>');
	}
}if($die) {
	if($status) {
		echo('<li>'.$status.'</li>');
	}
	echo('<li>working...</li>');
	exit();
}
}if((!$ntfwml_options || !isset($ntfwml_options['status']))) {
	if(($status = update_galleries($ntfwml_ngg_galleries,$update_galleries_limit) === true)) {
		if(!$ntfwml_options) {
			$ntfwml_options = array();
		}
		$ntfwml_options['status'] = 'galleries done';
		$ntfwml_options['messages'][] = 'Galleries done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'galleries done')) {
	if(($status = update_pictures($ntfwml_ngg_pictures,$ntfwml_ngg_galleries,$ntfwml_options,$update_pictures_limit) === true)) {
		$ntfwml_options['status'] = 'pictures done';
		$ntfwml_options['messages'][] = 'Pictures done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'pictures done')) {
	if(($status = update_albums($ntfwml_ngg_album,$update_albums_limit) === true)) {
		$ntfwml_options['status'] = 'albums done';
		$ntfwml_options['messages'][] = 'Albums done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'albums done')) {
	if(($status = update_thumbnails($update_thumbnails_limit) === true)) {
		$ntfwml_options['status'] = 'thumbnails done';
		$ntfwml_options['messages'][] = 'Thumbnails done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'thumbnails done')) {
	register_nextgen_gallery_taxonomy();
	if(($status = update_term_relationships_setup($ntfwml_ngg_pictures,$ntfwml_options,$update_term_relationships_setup_limit) === true)) {
		$ntfwml_options['status'] = 'term relationships setup done';
		$ntfwml_options['messages'][] = 'Term relationships setup done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}function register_new_ngg_tag_taxonomy_for_wp_attachments() {
	$labels = array('name' => _x('NGG Tags','taxonomy general name'),'singular_name' => _x('NGG Tag','taxonomy singular name'));$args = array('label' => __('NGG Tags'),'labels' => $labels,'show_ui' => true,'show_admin_column' => true,'rewrite' => array('slug' => 'ngg_tag'));register_taxonomy('ngg_tag','attachment',$args);register_taxonomy_for_object_type('ngg_tag','attachment');
}if(($ntfwml_options['status'] === 'term relationships setup done')) {
	register_new_ngg_tag_taxonomy_for_wp_attachments();
	if(($status = update_term_relationships($ntfwml_ngg_pictures,$ntfwml_options,$update_term_relationships_limit) === true)) {
		$ntfwml_options['status'] = 'term relationships done';
		$ntfwml_options['messages'][] = 'Term relationships done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'term relationships done')) {
	if(($status = update_post_content($update_post_content_limit) === true)) {
		$ntfwml_options['status'] = 'post content done';
		$ntfwml_options['messages'][] = 'Post content done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
		send_all_messages_to_browser($ntfwml_options,true);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}if(($ntfwml_options['status'] === 'post content done')) {
	if(($status = update_attachment_metadata($update_attachment_metadata_limit) === true)) {
		$ntfwml_options['status'] = 'attachment metadata done';
		$ntfwml_options['messages'][] = 'Attachment metadata done.';
		update_option('nggtags_for_wp_media_library',$ntfwml_options);
	}
	else {
	  send_all_messages_to_browser($ntfwml_options,true,$status);
	}
	
}$ntfwml_options['messages'][] = 'The conversion of NextGEN Gallery to WordPress Media Library is done.';send_all_messages_to_browser($ntfwml_options,false);$ntfwml_options = array('status' => 'update done');update_option('nggtags_for_wp_media_library',$ntfwml_options);exit();
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10693, 2907, "wp_get_attachment_link", "function ($link,$id,$size,$permalink,$icon,$text)
{
	$attachment_link = get_attachment_link(intval($id));if((strpos($link,'?attachment_id') === false)) {
	$link = preg_replace('/<a\s/','<a data-attachment-link="'.$attachment_link.'" ',$link);
}return $link;
}", 100, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10694, 2907, "posts_where", "function ($where)
{
	global $wpdb;if((strpos($_SERVER['REQUEST_URI'],'nggtags-for-wp-media-library/upload.php') === false)) {
	return $where;
}if((array_key_exists('filter-post-mime-type',$_REQUEST) && (array_search('0-nggml-all',$_REQUEST['filter-post-mime-type']) === FALSE))) {
	$where .= ((' AND '.$wpdb->posts.'.post_mime_type IN ( ' . implode(', ',array_map(function ($slug)
	{
		global $wpdb;return $wpdb->prepare('%s',$slug);
	},$_REQUEST['filter-post-mime-type']))) . ' ) ');
}if((array_key_exists('filter-attached-to',$_REQUEST) && (array_search('0-nggml-all',$_REQUEST['filter-attached-to']) === FALSE))) {
	$where .= ((' AND '.$wpdb->posts.'.post_parent IN ( ' . implode(', ',array_map(function ($id)
	{
		global $wpdb;return $wpdb->prepare('%d',$id);
	},$_REQUEST['filter-attached-to']))) . ' ) ');
}$ids = false;foreach($_REQUEST as $taxonomy => $slugs) {
	if((substr_compare($taxonomy,'filter-',0,7) !== 0)) {
		continue;
	}
	if((($taxonomy === 'filter-post-mime-type') || ($taxonomy === 'filter-attached-to'))) {
		continue;
	}
	if(($slugs[0] === '0-nggml-all')) {
		continue;
	}
	$slugs = implode(', ',array_map(function ($slug)
	{
		global $wpdb;return $wpdb->prepare('%s',$slug);
	},$slugs));
	$taxonomy = $wpdb->prepare('%s',substr($taxonomy,7));
	$sql = '          SELECT r.object_id FROM '.$wpdb->term_relationships.' r, '.$wpdb->term_taxonomy.' x, '.$wpdb->terms.' t
	            WHERE r.term_taxonomy_id = x.term_taxonomy_id AND x.term_id = t.term_id
	              AND x.taxonomy = '.$taxonomy.' and t.slug IN ( '.$slugs.' )';
	$objects = $wpdb->get_col($sql);
	if(!$objects) {
		return ($where . ' AND  1 = 2 ');
	}
	if($ids) {
		$ids = array_intersect($ids,$objects);
		if(!$ids) {
			return ($where . ' AND  1 = 2 ');
		}
	}
	else {
	  $ids = $objects;
	}
	
}if(($ids === false)) {
	return $where;
}$where .= ((' AND '.$wpdb->posts.'.ID IN ( ' . implode(', ',$ids)) . ' ) ');return $where;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10695, 2907, "plugin_action_links", "function ($actions,$plugin_file,$plugin_data,$context)
{
	if((strpos($plugin_file,basename(__FILE__)) !== false)) {
	array_unshift($actions,(((('<a href="' . admin_url('options-general.php?page=nggtags_for_media_library_settings_page')) . '">') . __('Settings')) . '</a>'));
}return $actions;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10696, 2907, "pre_update_option", "function ($new_value,$option,$old_value)
{
	if((strpos($option,'nggtags_for_media_library_taxonomy_slug_') !== 0)) {
	return $new_value;
}if(($old_value && $new_value)) {
	return $old_value;
}return $new_value;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10697, 2907, "posts_join", "function ($join)
{
	global $wpdb;if((strpos($_SERVER['REQUEST_URI'],'nggtags-for-wp-media-library/upload.php') === false)) {
	return $join;
}return ($join . '        LEFT JOIN ( SELECT '.$wpdb->term_relationships.'.object_id, '.$wpdb->terms.'.name
            FROM '.$wpdb->term_relationships.'
            INNER JOIN '.$wpdb->term_taxonomy.' ON '.$wpdb->term_relationships.'.term_taxonomy_id = '.$wpdb->term_taxonomy.'.term_taxonomy_id
            INNER JOIN '.$wpdb->terms.' ON '.$wpdb->term_taxonomy.'.term_id = '.$wpdb->terms.'.term_id
            WHERE '.$wpdb->term_taxonomy.'.taxonomy = 'priority'
        ) priority ON '.$wpdb->posts.'.ID = priority.object_id');
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10698, 2907, "posts_where", "function ($where)
{
	global $wpdb;if(!is_nggtags_media_library_request()) {
	return $where;
}if((strpos($_REQUEST['s'],'tags:') === 0)) {
	list(, $tags) = explode(':',$_REQUEST['s'],2);
	$tags = (('"' . implode('","',array_map(function ($tag)
	{
		return strtolower(str_replace(' ','-',$tag));
	},explode(',',$tags)))) . '"');
	if((strpbrk($tags,' 
		()') !== false)) {
		exit();
	}
	$where = ' AND '.$wpdb->posts.'.post_type = 'attachment' AND ( '.$wpdb->posts.'.post_status = 'inherit' OR '.$wpdb->posts.'.post_status = 'private' ) 
	 AND EXISTS ( SELECT * FROM '.$wpdb->term_relationships.' r, '.$wpdb->term_taxonomy.' x, '.$wpdb->terms.' t
	    WHERE r.object_id = '.$wpdb->posts.'.ID AND r.term_taxonomy_id = x.term_taxonomy_id AND x.term_id = t.term_id
	        AND t.slug IN ( '.$tags.' ) )';
}
else {
  if((strpos($_REQUEST['s'],'gallery:') === 0)) {
	list(, $galleries) = explode(':',$_REQUEST['s'],2);
	$galleries = (('"' . implode('","',array_map(function ($tag)
	{
		return strtolower(str_replace(' ','-',$tag));
	},explode(',',$galleries)))) . '"');
	if((strpbrk($galleries,' 
		()') !== false)) {
		exit();
	}
	$galleries = $wpdb->get_col('SELECT ID from '.$wpdb->posts.' where post_name IN ( '.$galleries.' )');
	$galleries = ((' "' . implode('",',$galleries)) . '" ');
	$where = ' AND '.$wpdb->posts.'.post_type = 'attachment' AND ( '.$wpdb->posts.'.post_status = 'inherit' OR '.$wpdb->posts.'.post_status = 'private' ) 
	 AND '.$wpdb->posts.'.post_parent IN ( '.$galleries.' )';
}
else {
  return $where;
}

}
return $where;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10699, 2907, "post_limits", "function ($limit,&$query)
{
	if(!$query->is_main_query()) {
	return $limit;
}return ' ';
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10700, 2907, "posts_where", "function ($where,$query)
{
	global $wpdb;if((!$query->is_main_query() || !array_key_exists('search_media_library_for_nggtags_form',$_REQUEST))) {
	return $where;
}$and_or = ($_REQUEST['search_media_library_for_nggtags_and_or'] == 'and')?'AND':'OR';$results = $wpdb->get_results('            SELECT x.taxonomy, t.name, x.term_taxonomy_id
                FROM '.$wpdb->term_taxonomy.' x, '.$wpdb->terms.' t
                WHERE x.term_id = t.term_id
                GROUP BY x.term_taxonomy_id',OBJECT);$term_taxonomy_ids = array();foreach($results as $result) {
	$term_taxonomy_ids[$result->taxonomy][strtolower($result->name)] = $result->term_taxonomy_id;
}$results = $wpdb->get_results('            SELECT g.post_title, g.ID
                FROM '.$wpdb->posts.' g, '.$wpdb->posts.' a
                WHERE g.ID = a.post_parent AND a.post_type = 'attachment' AND a.post_mime_type LIKE "image/%"
                GROUP BY g.ID',OBJECT);$gallery_ids = array();foreach($results as $result) {
	$gallery_ids[strtolower($result->post_title)] = $result->ID;
}$results = $wpdb->get_results('            SELECT u.display_name, u.ID
                FROM '.$wpdb->users.' u, '.$wpdb->posts.' a
                WHERE u.ID = a.post_author AND a.post_type = 'attachment' AND a.post_mime_type LIKE "image/%"
                GROUP BY u.ID',OBJECT);$author_ids = array();foreach($results as $result) {
	$author_ids[strtolower($result->display_name)] = $result->ID;
}$suffix_len = strlen(Search_Media_Library_by_Taxonomy_Widget::OPTIONAL_TEXT_VALUE_SUFFIX
);foreach($_REQUEST as $index => &$request) {
	if((($request && (substr_compare($index,Search_Media_Library_by_Taxonomy_Widget::OPTIONAL_TEXT_VALUE_SUFFIX
	,-$suffix_len) === 0)) && $request)) {
		$index = substr($index,0,(strlen($index) - $suffix_len));
		if((is_array($_REQUEST[$index]) || !array_key_exists($index,$_REQUEST))) {
			$lowercase_request = strtolower($request);
			if((substr_compare($index,'tax-',0,4) === 0)) {
				$tax_name = substr($index,8);
				if((!array_key_exists($tax_name,$term_taxonomy_ids) || !array_key_exists($lowercase_request,$term_taxonomy_ids[$tax_name]))) {
					$request = NULL;
					continue;
				}
				$request = $term_taxonomy_ids[$tax_name][$lowercase_request];
			}
			else {
			  if(($index === 'pst-std-post_parent')) {
				if(!array_key_exists($lowercase_request,$gallery_ids)) {
					$request = NULL;
					continue;
				}
				$request = $gallery_ids[$lowercase_request];
			}
			else {
			  if(($index === 'pst-std-post_author')) {
				if(!array_key_exists($lowercase_request,$author_ids)) {
					$request = NULL;
					continue;
				}
				$request = $author_ids[$lowercase_request];
			}
			}
			
			}
			
			$_REQUEST[$index][] = $request;
		}
		$request = NULL;
	}
}unset($request);$non_field_keys = array('search_media_library_for_nggtags_form','search_media_library_for_nggtags_widget_option','search_media_library_for_nggtags_widget_number','search_media_library_for_nggtags_and_or','post_type','paged');$sql = '';foreach($_REQUEST as $key => $values) {
	if(!$values) {
		continue;
	}
	if(in_array($key,$non_field_keys)) {
		continue;
	}
	$prefix = substr($key,0,8);
	if((($prefix !== 'tax-cat-') && ($prefix !== 'tax-tag-'))) {
		continue;
	}
	if(!is_array($values)) {
		if($values) {
			$values = array($values);
		}
		else {
		  continue;
		}
		
	}
	$values = array_filter($values);
	if(!$values) {
		continue;
	}
	$taxonomy = substr($key,8);
	if($sql) {
		$sql .= ' '.$and_or.' ';
	}
	$sql .= ' EXISTS ( SELECT * FROM '.$wpdb->term_relationships.' WHERE ( ';
	foreach($values as $value) {
		if(($value !== $values[0])) {
			$sql .= ' OR ';
		}
		$sql .= $wpdb->prepare('term_taxonomy_id = %s',$value);
	}
	$sql .= ') AND object_id = p.ID )';
}if($sql) {
	$sql = '                SELECT ID FROM '.$wpdb->posts.' p
	                    WHERE p.post_type = 'attachment' AND p.post_mime_type LIKE 'image/%' AND ( '.$sql.' )';
	$ids1 = $wpdb->get_col($sql);
	if((($and_or == 'AND') && !$ids1)) {
		return ' AND 1 = 2 ';
	}
}
else {
  $ids1 = FALSE;
}
$ids = $ids1;if(((($and_or == 'AND') && ($ids !== FALSE)) && !$ids)) {
	return ' AND 1 = 2 ';
}$ids2 = FALSE;$ids = Search_Media_Library_by_Taxonomy_Widget::join_arrays($and_or,$ids,$ids2);if(((($and_or == 'AND') && ($ids !== FALSE)) && !$ids)) {
	return ' AND 1 = 2 ';
}if((array_key_exists('pst-std-post_content',$_REQUEST) && $_REQUEST['pst-std-post_content'])) {
	$sql = $wpdb->prepare('                SELECT ID FROM '.$wpdb->posts.'
	                    WHERE post_type = 'attachment' AND post_mime_type LIKE 'image/%%'
	                        AND ( post_content LIKE %s OR post_title LIKE %s OR post_excerpt LIKE %s )','%'.$_REQUEST['pst-std-post_content'].'%','%'.$_REQUEST['pst-std-post_content'].'%','%'.$_REQUEST['pst-std-post_content'].'%');
	$ids3 = $wpdb->get_col($sql);
	if((($and_or == 'AND') && !$ids3)) {
		return ' AND 1 = 2 ';
	}
}
else {
  $ids3 = FALSE;
}
$ids = Search_Media_Library_by_Taxonomy_Widget::join_arrays($and_or,$ids,$ids3);if(((($and_or == 'AND') && ($ids !== FALSE)) && !$ids)) {
	return ' AND 1 = 2 ';
}if((array_key_exists('pst-std-post_author',$_REQUEST) && $_REQUEST['pst-std-post_author'])) {
	$sql = ((('SELECT ID FROM '.$wpdb->posts.' WHERE post_type = 'attachment' AND post_mime_type LIKE 'image/%'' . ' AND post_author IN ( ') . implode(',',$_REQUEST['pst-std-post_author'])) . ' )');
	$ids4 = $wpdb->get_col($sql);
	if((($and_or == 'AND') && !$ids4)) {
		return ' AND 1 = 2 ';
	}
}
else {
  $ids4 = FALSE;
}
$ids = Search_Media_Library_by_Taxonomy_Widget::join_arrays($and_or,$ids,$ids4);if(((($and_or == 'AND') && ($ids !== FALSE)) && !$ids)) {
	return ' AND 1 = 2 ';
}if((array_key_exists('pst-std-post_parent',$_REQUEST) && $_REQUEST['pst-std-post_parent'])) {
	$sql = ((('SELECT ID FROM '.$wpdb->posts.' WHERE post_type = 'attachment' AND post_mime_type LIKE 'image/%'' . ' AND post_parent IN ( ') . implode(',',$_REQUEST['pst-std-post_parent'])) . ' )');
	$ids5 = $wpdb->get_col($sql);
	if((($and_or == 'AND') && !$ids5)) {
		return ' AND 1 = 2 ';
	}
}
else {
  $ids5 = FALSE;
}
$ids = Search_Media_Library_by_Taxonomy_Widget::join_arrays($and_or,$ids,$ids5);if(((($and_or == 'AND') && ($ids !== FALSE)) && !$ids)) {
	return ' AND 1 = 2 ';
}if($ids) {
	$ids = implode(', ',$ids);
	$where = ' AND ID IN ( '.$ids.' ) ';
}
else {
  $where = ' AND 1 = 2 ';
}
return $where;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10701, 2907, "post_limits_request", "function ($limits)
{
	global $wpdb;if(is_nggtags_media_library_request()) {
	$limits = 'LIMIT 0, 256';
}return $limits;
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10702, 2907, "posts_orderby", "function ($order_by)
{
	global $wpdb;if((strpos($_SERVER['REQUEST_URI'],'nggtags-for-wp-media-library/upload.php') === false)) {
	return $order_by;
}return ('CAST( IF ( priority.name IS NOT NULL, priority.name, ~0 ) AS UNSIGNED ) ASC, ' . 'CAST( IF ( '.$wpdb->posts.'.ID IS NOT NULL, '.$wpdb->posts.'.ID, ~0 ) AS UNSIGNED ) ASC');
}", 10, now(), now());
insert into filters (id, plugin_id, tag_name, filter_callback, filter_priority, created, modified) values (10703, 2907, "terms_to_edit", "function ($tags_to_edit,$taxonomy)
{
	global $nggtags_for_wp_media_library_in_inline_edit_tags_to_edit;if(!$nggtags_for_wp_media_library_in_inline_edit_tags_to_edit) {
	return $tags_to_edit;
}return $nggtags_for_wp_media_library_in_inline_edit_tags_to_edit;
}", 10, now(), now());